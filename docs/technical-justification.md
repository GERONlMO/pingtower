# PingTower - Техническое обоснование архитектуры и стека

## Обзор системы

PingTower - это распределенная система мониторинга веб-сервисов, обеспечивающая непрерывный контроль доступности, производительности и SSL-сертификатов веб-ресурсов в реальном времени.

## Архитектурные принципы

### 1. Микросервисная архитектура
**Обоснование:**
- **Масштабируемость**: Каждый сервис можно масштабировать независимо
- **Отказоустойчивость**: Сбой одного сервиса не влияет на работу остальных
- **Технологическая гибкость**: Возможность использовать оптимальные технологии для каждой задачи
- **Команды разработки**: Разные команды могут работать над разными сервисами независимо

### 2. Event-Driven Architecture (EDA)
**Обоснование:**
- **Асинхронность**: Обработка событий не блокирует основные операции
- **Слабая связанность**: Сервисы взаимодействуют через события, а не прямые вызовы
- **Реактивность**: Система быстро реагирует на изменения состояния сервисов

## Технологический стек

### Backend Services

#### Java 17 + Spring Boot 3.x
**Обоснование выбора:**
- **Производительность**: Java 17 включает улучшения производительности и новые возможности
- **Экосистема**: Богатая экосистема библиотек и фреймворков
- **Spring Boot**: Rapid development, автоконфигурация, production-ready features
- **Корпоративный стандарт**: Широко используется в enterprise-решениях
- **Поддержка**: Долгосрочная поддержка (LTS) Java 17

#### Spring Cloud Gateway
**Обоснование:**
- **Единая точка входа**: Централизованная маршрутизация запросов
- **Безопасность**: Централизованная аутентификация и авторизация
- **Мониторинг**: Единое место для логирования и метрик
- **Rate Limiting**: Защита от перегрузки backend-сервисов
- **Reactive**: Неблокирующая архитектура для высокой производительности

### Базы данных

#### PostgreSQL (Основная БД)
**Обоснование:**
- **ACID**: Полная поддержка транзакций для критически важных данных
- **Надежность**: Проверенное временем решение для production-систем
- **JSON поддержка**: Гибкость работы с полуструктурированными данными (конфигурации проверок)
- **Расширяемость**: Богатые возможности индексации и оптимизации
- **Open Source**: Отсутствие лицензионных ограничений

#### ClickHouse (Аналитическая БД)
**Обоснование:**
- **OLAP оптимизация**: Специально разработана для аналитических запросов
- **Колоночное хранение**: Эффективная компрессия и быстрые агрегации
- **Высокая производительность**: Обработка миллионов записей в секунду
- **Time-series данные**: Оптимальна для хранения метрик мониторинга
- **Масштабируемость**: Горизонтальное масштабирование

### Очереди сообщений

#### Apache Kafka
**Обоснование:**
- **Высокая пропускная способность**: Обработка миллионов сообщений в секунду
- **Долговременное хранение**: Возможность replay событий
- **Партиционирование**: Параллельная обработка сообщений
- **Отказоустойчивость**: Репликация данных между брокерами
- **Стандарт индустрии**: Широко используется в high-load системах

### Мониторинг и проверки

#### Selenium WebDriver
**Обоснование:**
- **Браузерные тесты**: Полная эмуляция пользовательского опыта
- **JavaScript поддержка**: Тестирование SPA приложений
- **Метрики производительности**: DOM Load Time, Time to First Byte
- **Кроссбраузерность**: Поддержка различных браузеров
- **Стандарт**: De-facto стандарт для браузерной автоматизации

#### Quartz Scheduler
**Обоснование:**
- **Надежность**: Проверенное решение для критичных задач
- **Кластеризация**: Распределенное выполнение задач
- **Персистентность**: Сохранение состояния в БД
- **Гибкость**: Сложные расписания с Cron-выражениями
- **Spring интеграция**: Нативная поддержка в Spring Boot

### Frontend

#### Vanilla JavaScript + WebSocket (SockJS + STOMP)
**Обоснование:**
- **Простота**: Отсутствие сложных зависимостей и сборки
- **Производительность**: Минимальный overhead
- **Реальное время**: WebSocket для мгновенных обновлений
- **Совместимость**: SockJS обеспечивает fallback для старых браузеров
- **Стандарты**: STOMP протокол для структурированного обмена сообщениями

## Архитектурные решения

### 1. API Gateway Pattern
**Проблема**: Прямое обращение клиентов к микросервисам создает связанность и усложняет безопасность.

**Решение**: Единая точка входа через API Gateway.

**Преимущества**:
- Централизованная аутентификация
- Единое логирование и мониторинг
- Версионирование API
- Rate limiting и защита от DDoS

### 2. CQRS (Command Query Responsibility Segregation)
**Проблема**: Разные требования к чтению и записи данных.

**Решение**: Разделение на PostgreSQL (команды) и ClickHouse (запросы).

**Преимущества**:
- Оптимизация производительности для каждого типа операций
- Независимое масштабирование
- Специализированные индексы и схемы

### 3. Event Sourcing для метрик
**Проблема**: Необходимость хранения временных рядов и аналитики.

**Решение**: Все события мониторинга сохраняются в ClickHouse.

**Преимущества**:
- Полная история изменений
- Возможность пересчета метрик
- Аналитика и отчетность

### 4. Bulkhead Pattern
**Проблема**: Сбой в одном компоненте может повлиять на всю систему.

**Решение**: Изоляция сервисов и ресурсов.

**Преимущества**:
- Ограничение области влияния сбоев
- Независимое масштабирование
- Упрощение отладки

## Обоснование выбора портов

| Сервис | Порт | Обоснование |
|--------|------|-------------|
| API Gateway | 8080 | Стандартный порт для веб-приложений |
| Auth Service | 8081 | Последовательная нумерация сервисов |
| Control Tower | 8082 | Основной бизнес-сервис |
| Reporting Service | 8083 | Специализированный сервис отчетов |
| PostgreSQL | 5433 | Избежание конфликта с локальным PostgreSQL (5432) |
| ClickHouse HTTP | 8123 | Стандартный порт ClickHouse HTTP |
| ClickHouse Native | 9000 | Стандартный порт ClickHouse Native |
| Kafka | 9092 | Стандартный порт Kafka |
| Portainer | 9001 | Избежание конфликта с ClickHouse (9000) |

## Паттерны отказоустойчивости

### 1. Circuit Breaker
- Защита от каскадных сбоев
- Быстрое восстановление после сбоев
- Мониторинг состояния внешних зависимостей

### 2. Retry with Exponential Backoff
- Обработка временных сбоев сети
- Снижение нагрузки на восстанавливающиеся сервисы
- Настраиваемые политики повторов

### 3. Health Checks
- Автоматическое обнаружение неисправных инстансов
- Graceful degradation функциональности
- Мониторинг состояния всех компонентов

## Безопасность

### 1. JWT Authentication
- Stateless аутентификация
- Масштабируемость (нет необходимости в сессиях)
- Стандартизированный подход

### 2. CORS Configuration
- Защита от cross-origin атак
- Гибкая настройка разрешенных источников
- Поддержка preflight запросов

### 3. Network Isolation
- Изоляция сервисов в Docker сети
- Минимизация attack surface
- Контролируемое взаимодействие между компонентами

## Мониторинг и наблюдаемость

### 1. Distributed Tracing
- Отслеживание запросов через микросервисы
- Идентификация узких мест производительности
- Корреляция логов и метрик

### 2. Metrics Collection
- Бизнес-метрики (uptime, response time)
- Технические метрики (CPU, память, сеть)
- Пользовательские метрики (количество проверок, алерты)

### 3. Centralized Logging
- Агрегация логов всех сервисов
- Структурированное логирование (JSON)
- Корреляция событий по trace ID

## Масштабируемость

### Горизонтальное масштабирование
- **Stateless сервисы**: Все сервисы не хранят состояние
- **Database partitioning**: Шардирование данных по времени
- **Load balancing**: Распределение нагрузки между инстансами

### Вертикальное масштабирование
- **Resource optimization**: Настройка JVM параметров
- **Database tuning**: Оптимизация индексов и запросов
- **Connection pooling**: Эффективное использование соединений

## Заключение

Выбранная архитектура и технологический стек обеспечивают:

1. **Высокую доступность** - через микросервисную архитектуру и паттерны отказоустойчивости
2. **Масштабируемость** - горизонтальное и вертикальное масштабирование
3. **Производительность** - специализированные БД для разных типов нагрузки
4. **Maintainability** - четкое разделение ответственности и стандартизированный стек
5. **Безопасность** - современные подходы к аутентификации и авторизации
6. **Наблюдаемость** - комплексный мониторинг и логирование

Данная архитектура готова к production-развертыванию и может обслуживать тысячи мониторируемых сервисов с высокой надежностью и производительностью.
