<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PingTower Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #bb86fc;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        th, td {
            border: 1px solid #333;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #1f1f1f;
            color: #bb86fc;
        }
        tbody tr:nth-child(even) {
            background-color: #1e1e1e;
        }
        tbody tr:hover {
            background-color: #333;
        }
        .status {
            padding: 5px 10px;
            border-radius: 5px;
            color: #fff;
            text-align: center;
            font-weight: bold;
        }
        .status-ok { background-color: #03dac6; }
        .status-warn { background-color: #fdd835; color: #000;}
        .status-crit { background-color: #cf6679; }
        .status-unknown { background-color: #424242; }
        .connection-status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status-connected { background-color: #03dac6; color: #000; }
        .status-disconnected { background-color: #cf6679; }
    </style>
</head>
<body>

<h1>PingTower Dashboard</h1>
<div id="connection-status" class="connection-status status-disconnected">Connecting...</div>
<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Env</th>
        <th>Status</th>
        <th>P95 (ms)</th>
        <th>Avg (ms)</th>
        <th>Up %</th>
        <th>Ok</th>
        <th>Last Check</th>
        <th>Online</th>
    </tr>
    </thead>
    <tbody id="dashboard-body">
    </tbody>
</table>

<script type="text/javascript">
    const dashboardBody = document.getElementById('dashboard-body');
    const connectionStatusDiv = document.getElementById('connection-status');
    const serviceData = new Map();

    function connect() {
        const socket = new SockJS('http://localhost:8081/ws/dashboard');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            setConnectionStatus(true);
            
            // Subscribe to get the initial snapshot
            stompClient.subscribe('/app/dashboard', function (message) {
                const snapshot = JSON.parse(message.body);
                console.log("Received snapshot:", snapshot);
                snapshot.forEach(service => serviceData.set(service.id, service));
                renderTable();
            });

            // Subscribe to get real-time updates
            stompClient.subscribe('/topic/dashboard.update', function (message) {
                const updatedService = JSON.parse(message.body);
                console.log("Received update:", updatedService);
                serviceData.set(updatedService.id, updatedService);
                renderTable();
            });

        }, function(error) {
            console.error('STOMP error:', error);
            setConnectionStatus(false);
            setTimeout(connect, 5000); // Attempt to reconnect after 5 seconds
        });
    }
    
    function renderTable() {
        dashboardBody.innerHTML = '';
        const sortedServices = Array.from(serviceData.values()).sort((a, b) => a.id.localeCompare(b.id));

        for (const service of sortedServices) {
            const row = document.createElement('tr');
            
            const statusInfo = getStatusInfo(service.st);

            row.innerHTML = `
                <td>${service.id}</td>
                <td>${service.n}</td>
                <td>${service.e}</td>
                <td><div class="status ${statusInfo.className}">${statusInfo.text}</div></td>
                <td>${service.p95.toFixed(2)}</td>
                <td>${service.avg.toFixed(2)}</td>
                <td>${service.up.toFixed(2)}%</td>
                <td>${service.ok}</td>
                <td>${formatDate(service.lc)}</td>
                <td>${service.io ? '✅' : '❌'}</td>
            `;
            dashboardBody.appendChild(row);
        }
    }

    function getStatusInfo(statusCode) {
        switch (statusCode) {
            case 1: return { text: 'OK', className: 'status-ok' };
            case 0: return { text: 'CRIT', className: 'status-crit' };
            // Add more cases here, e.g., for WARN
            default: return { text: 'UNKNOWN', className: 'status-unknown' };
        }
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString();
    }
    
    function setConnectionStatus(isConnected) {
        if (isConnected) {
            connectionStatusDiv.textContent = 'Connected';
            connectionStatusDiv.className = 'connection-status status-connected';
        } else {
            connectionStatusDiv.textContent = 'Disconnected. Retrying...';
            connectionStatusDiv.className = 'connection-status status-disconnected';
        }
    }

    connect();
</script>

</body>
</html>
